<%- include('../layouts/main', { title: 'My Profile' }) %>

<div class="container mt-5 pt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle mx-auto" style="width: 100px; height: 100px;">
                            <% if (user.profileImage) { %>
                                <img src="<%= user.profileImage %>" alt="Profile" class="rounded-circle" width="100" height="100">
                            <% } else { %>
                                <span class="avatar-initials" style="font-size: 2.5rem"><%= user.name.charAt(0).toUpperCase() %></span>
                            <% } %>
                        </div>
                        <h4 class="mt-3 mb-1"><%= user.name %></h4>
                        <p class="text-muted mb-3"><%= user.email %></p>
                    </div>

                    <% if (messages.success) { %>
                        <div class="alert alert-success">
                            <%= messages.success %>
                        </div>
                    <% } %>

                    <% if (messages.error) { %>
                        <div class="alert alert-danger">
                            <%= messages.error %>
                        </div>
                    <% } %>

                    <form action="/profile" method="POST" enctype="multipart/form-data">
                        <!-- Profile Image Upload -->
                        <div class="mb-3">
                            <label for="profileImage" class="form-label">Profile Image</label>
                            <input type="file" class="form-control" id="profileImage" name="profileImage" accept="image/*">
                            <div class="form-text">Upload a square image for best results</div>
                        </div>

                        <!-- Name -->
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="<%= user.name %>" required>
                        </div>

                        <!-- Email (readonly) -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="<%= user.email %>" readonly>
                            <div class="form-text">Email cannot be changed</div>
                        </div>

                        <!-- Role -->
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control" value="<%= user.role.name.charAt(0).toUpperCase() + user.role.name.slice(1) %>" readonly>
                        </div>

                        <!-- Change Password Section -->
                        <div class="mt-4">
                            <h5 class="mb-3">Change Password</h5>
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" name="currentPassword">
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" name="newPassword">
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword">
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Account Settings Section -->
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Account Settings</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="/settings" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Notification Preferences</h6>
                                <p class="mb-0 text-muted">Manage your email and browser notifications</p>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="/settings#security" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Security Settings</h6>
                                <p class="mb-0 text-muted">Configure your account security options</p>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="/settings#privacy" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Privacy</h6>
                                <p class="mb-0 text-muted">Control your privacy settings</p>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card shadow-sm mt-4 border-danger">
                <div class="card-header text-danger">
                    <h5 class="mb-0">Danger Zone</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Deactivate Account</h6>
                            <p class="text-muted mb-0">Temporarily disable your account</p>
                        </div>
                        <button class="btn btn-outline-danger" onclick="if(confirm('Are you sure you want to deactivate your account?')) document.getElementById('deactivateForm').submit();">
                            Deactivate
                        </button>
                    </div>
                    <form id="deactivateForm" action="/profile/deactivate" method="POST" style="display: none;"></form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Preview profile image before upload
document.getElementById('profileImage')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.querySelector('.avatar-circle img') || document.createElement('img');
            img.src = e.target.result;
            img.classList.add('rounded-circle');
            img.setAttribute('width', '100');
            img.setAttribute('height', '100');
            
            const initials = document.querySelector('.avatar-circle .avatar-initials');
            if (initials) {
                initials.style.display = 'none';
            }
            
            const avatarCircle = document.querySelector('.avatar-circle');
            if (!avatarCircle.contains(img)) {
                avatarCircle.appendChild(img);
            }
        }
        reader.readAsDataURL(file);
    }
});

// Password validation
document.querySelector('form').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const currentPassword = document.getElementById('currentPassword').value;
    
    if (newPassword || confirmNewPassword || currentPassword) {
        if (newPassword !== confirmNewPassword) {
            e.preventDefault();
            alert('New passwords do not match!');
        } else if (!currentPassword) {
            e.preventDefault();
            alert('Please enter your current password to change password!');
        } else if (newPassword.length < 6) {
            e.preventDefault();
            alert('New password must be at least 6 characters long!');
        } else if (!/\d/.test(newPassword)) {
            e.preventDefault();
            alert('New password must contain at least one number!');
        }
    }
});
</script>